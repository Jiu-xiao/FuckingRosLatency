name: ROS2 Image Latency Benchmark

on:
  workflow_dispatch: {}

jobs:
  bench:
    runs-on: ubuntu-22.04

    env:
      ROS_DISTRO: humble
      WS: ${{ github.workspace }}/ros2_ws }

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install ROS2 Humble and tools
        run: |
          set -e
          sudo apt-get update
          sudo apt-get install -y curl gnupg2 lsb-release

          # ROS2 apt 源
          sudo curl -sSL https://raw.githubusercontent.com/ros/rosdistro/master/ros.key \
            -o /usr/share/keyrings/ros-archive-keyring.gpg

          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/ros-archive-keyring.gpg] \
          http://packages.ros.org/ros2/ubuntu $(lsb_release -cs) main" \
          | sudo tee /etc/apt/sources.list.d/ros2.list > /dev/null

          sudo apt-get update
          sudo apt-get install -y \
            ros-humble-ros-base \
            python3-colcon-common-extensions \
            build-essential \
            cmake \
            sysstat \
            pkg-config \
            libudev-dev \
            libwpa-client-dev \
            libnm-dev

      - name: Prepare workspace
        run: |
          set -e
          mkdir -p "$WS/src"

          # 拷贝 ROS2 benchmark 包
          cp -r src/image_latency_test "$WS/src/"

          # 拷贝 libxr_tp_test 包
          cp -r libxr_tp_test "$WS/src/"

          # 在 libxr_tp_test 里克隆 LibXR 源码到 libxr 子目录
          cd "$WS/src/libxr_tp_test"
          git clone --depth 1 https://github.com/Jiu-xiao/libxr.git libxr

          # 拷贝自动测试脚本
          cd "$WS"
          cp "${GITHUB_WORKSPACE}/auto_bench_image_latency.sh" .
          cp "${GITHUB_WORKSPACE}/auto_bench_libxr_image_latency.sh" .
          chmod +x ./auto_bench_image_latency.sh
          chmod +x ./auto_bench_libxr_image_latency.sh

      - name: Build workspace (image_latency_test + libxr_tp_test)
        run: |
          set -e
          source /opt/ros/${ROS_DISTRO}/setup.bash
          cd "$WS"
          colcon build --packages-select image_latency_test libxr_tp_test

      - name: Run ROS benchmark 1440x1080
        run: |
          set -e
          source /opt/ros/${ROS_DISTRO}/setup.bash
          cd "$WS"
          ./auto_bench_image_latency.sh

      - name: Run ROS benchmark 320x240
        run: |
          set -e
          source /opt/ros/${ROS_DISTRO}/setup.bash
          cd "$WS"
          WIDTH=320 HEIGHT=240 ./auto_bench_image_latency.sh

      - name: Run LibXR image latency test
        run: |
          set -e
          source /opt/ros/${ROS_DISTRO}/setup.bash
          cd "$WS"
          ./auto_bench_libxr_image_latency.sh

      - name: Upload logs
        uses: actions/upload-artifact@v4
        with:
          name: image-latency-logs
          path: ${{ env.WS }}/logs
